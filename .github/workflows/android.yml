name: Android Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake ninja-build pkg-config wget unzip python3-pip
        pip3 install meson ninja

    - name: Build project
      run: |
        # Enable debug tracing and exit on error
        set -x
        set -e
        
        # Print current directory
        echo "=== Current Directory ==="
        pwd
        
        # List all files in repository root
        echo "=== Repository Root Files ==="
        ls -la
        
        # Check if buildscripts directory exists
        echo "=== Checking buildscripts directory ==="
        if [ -d "buildscripts" ]; then
          echo "✓ buildscripts directory found"
          
          # List buildscripts directory contents
          echo "=== buildscripts directory contents ==="
          ls -la buildscripts
          
          # Check if build.sh exists
          if [ -f "buildscripts/build.sh" ]; then
            echo "✓ build.sh found"
            
            # Add execute permissions
            echo "=== Adding execute permissions to build.sh ==="
            chmod +x buildscripts/build.sh
            
            # Run build.sh with debug output
            echo "=== Starting build process ==="
            buildscripts/build.sh --arch arm64 2>&1 || true
            echo "=== Build process completed with exit code: $? ==="
          else
            echo "✗ ERROR: build.sh not found in buildscripts directory!"
            exit 1
          fi
        else
          echo "✗ ERROR: buildscripts directory not found!"
          echo "=== Searching for build directories ==="
          find . -type d -name "*build*" | head -20
          exit 1
        fi
      shell: bash
      env:
        CI_DEBUG: "true"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: libmpv-android
        path: buildscripts/prefix/arm64-v8a/lib/libmpv.so
